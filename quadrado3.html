<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quadrado com Somas Guiadas</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="static/css/quadrado3.css">
</head>
<body>
<div class="container py-4">
    <div class="settings-box text-center">
        <h1 class="mb-4 text-center titulo">Quadrado com Somas Guiadas</h1>
        <div class="row justify-content-center mb-3">
            <div class="col-auto d-flex align-items-center">
                <label for="start" class="form-label mb-0 me-2 label-pequeno">N√∫mero inicial:</label>
                <input type="number" id="start" value="0" class="form-control input-config text-center" style="width: 90px;">
            </div>
        </div>
        <div class="btn-group-centered">
            <button type="button" class="btn btn-primary btn-novo" onclick="gerarDesafio()">Novo Desafio</button>
            <button id="toggleSumsBtn" type="button" class="btn btn-outline-primary btn-toggle" onclick="toggleSomas()">Mostrar Somas</button>
        </div>
        <form id="desafio-form" class="text-center" onsubmit="corrigirDesafio(event)">
            <div id="soma-grid" class="my-3"></div>
            <div id="copy-box" class="text-center mb-2"></div>
        </form>
    </div>
    <button type="submit" form="desafio-form" class="btn btn-success btn-corrigir mt-3">Corrigir</button>
    <div id="feedback" class="mt-3 text-center"></div>
    <div style="text-align: center;">
        <a href="index.html" class="btn btn-outline-secondary mb-3 btn-voltar">&larr; Voltar ao Menu</a>
    </div>
</div>
<script>
let respostaCorreta = [];
let startAtual = 0;
let magic = [];
let magicSum = 0;
let showSomas = false;
let preenchido = [
    [null, null, null],
    [null, null, null],
    [null, null, null]
];

function copyTexto(texto) {
    const box = document.getElementById('copy-box');
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(texto).then(() => {
            box.innerHTML = "<small class='text-success'>Copiado!</small>";
        }).catch(() => {
            box.innerHTML = "<small class='text-danger'>N√£o foi poss√≠vel copiar automaticamente.</small>";
        });
    } else {
        box.innerHTML = "<small class='text-danger'>Seu navegador n√£o permite c√≥pia autom√°tica.</small>";
    }
}

function gerarQuadrado(start) {
    let base = [
        [8, 1, 6],
        [3, 5, 7],
        [4, 9, 2]
    ];
    let ms = [];
    for (let i = 0; i < 3; i++) {
        ms[i] = [];
        for (let j = 0; j < 3; j++) {
            ms[i][j] = base[i][j] + (start - 1);
        }
    }
    return ms;
}

function calcularMagicSum(magicSquare) {
    return magicSquare[0].reduce((a, b) => a + b, 0);
}

function salvarPreenchido() {
    for (let i = 0; i < 3; i++) {
        for (let j = 0; j < 3; j++) {
            let el = document.getElementById(`cell-${i}-${j}`);
            if (el) {
                let val = el.value === '' ? null : parseInt(el.value);
                preenchido[i][j] = isNaN(val) ? null : val;
            }
        }
    }
}

function restaurarPreenchido() {
    for (let i = 0; i < 3; i++) {
        for (let j = 0; j < 3; j++) {
            let el = document.getElementById(`cell-${i}-${j}`);
            if (el) {
                el.value = preenchido[i][j] !== null ? preenchido[i][j] : '';
            }
        }
    }
}

function renderGrid() {
    let html = `<div class="grid-wrapper ${showSomas ? 'with-sums' : ''}">`;
    html += `<div class="grid-container ${showSomas ? 'with-sums' : ''}">`;
    for (let i = 0; i < 3; i++) {
        for (let j = 0; j < 3; j++) {
            html += `<input type="number" min="-999" max="999" class="magic-input" id="cell-${i}-${j}" autocomplete="off" style="grid-row: ${i+1}; grid-column: ${j+1};">`;
        }
        if (showSomas) {
            html += `<div class="sum-label sum-row" id="sum-row-${i}" style="grid-row: ${i+1}; grid-column: 4;">${magicSum}</div>`;
        }
    }
    if (showSomas) {
        for (let j = 0; j < 3; j++) {
            html += `<div class="sum-label sum-col" id="sum-col-${j}" style="grid-row: 4; grid-column: ${j+1};">${magicSum}</div>`;
        }
        html += `<div class="sum-label sum-diag" id="sum-diag" style="grid-row: 4; grid-column: 4;">${magicSum}</div>`;
    }
    html += `</div></div>`;
    document.getElementById("soma-grid").innerHTML = html;
    restaurarPreenchido();
}

function gerarDesafio() {
    const startVal = parseInt(document.getElementById('start').value, 10);
    startAtual = Number.isNaN(startVal) ? 1 : startVal;
    magic = gerarQuadrado(startAtual);
    respostaCorreta = JSON.parse(JSON.stringify(magic));
    magicSum = calcularMagicSum(magic);
    showSomas = false;
    document.getElementById("toggleSumsBtn").innerText = "Mostrar Somas";
    preenchido = [
        [null, null, null],
        [null, null, null],
        [null, null, null]
    ];
    renderGrid();
    document.getElementById("feedback").innerHTML = "";

    const texto = magic.map(r => r.join('\t')).join('\n');
    document.getElementById('copy-box').innerHTML = `
        <button type="button" class="btn btn-outline-primary btn-sm btn-copiar" onclick='copyTexto(${JSON.stringify(texto)})'>üìã Copiar quadrado</button>
        <div class="mt-1"><small class="text-muted">Texto tabulado (3x3) pronto para colar</small></div>
    `;
}

function toggleSomas() {
    salvarPreenchido();
    showSomas = !showSomas;
    document.getElementById("toggleSumsBtn").innerText = showSomas ? "Ocultar Somas" : "Mostrar Somas";
    renderGrid();
}

function corrigirDesafio(event) {
    event.preventDefault();
    salvarPreenchido();
    let correto = true;

    for (let i = 0; i < 3; i++) {
        let somaLinha = preenchido[i].reduce((a, b) => a + (typeof b === 'number' ? b : 0), 0);
        if (somaLinha !== magicSum) correto = false;
    }
    for (let j = 0; j < 3; j++) {
        let somaCol = preenchido.map(row => row[j]).reduce((a, b) => a + (typeof b === 'number' ? b : 0), 0);
        if (somaCol !== magicSum) correto = false;
    }
    let diag1 = (typeof preenchido[0][0] === 'number' ? preenchido[0][0] : 0) +
                (typeof preenchido[1][1] === 'number' ? preenchido[1][1] : 0) +
                (typeof preenchido[2][2] === 'number' ? preenchido[2][2] : 0);
    let diag2 = (typeof preenchido[0][2] === 'number' ? preenchido[0][2] : 0) +
                (typeof preenchido[1][1] === 'number' ? preenchido[1][1] : 0) +
                (typeof preenchido[2][0] === 'number' ? preenchido[2][0] : 0);
    if (diag1 !== magicSum || diag2 !== magicSum) correto = false;

    let filledAll = preenchido.flat().every(x => typeof x === 'number');
    let fb = document.getElementById("feedback");

    if (!filledAll) {
        fb.innerHTML = `<div class="alert alert-warning">Preencha todos os campos!</div>`;
    } else if (correto) {
        fb.innerHTML = `<div class="alert alert-success">Parab√©ns! Voc√™ completou o quadrado m√°gico corretamente.</div>`;
    } else {
        fb.innerHTML = `<div class="alert alert-danger">Ainda n√£o est√° correto. Confira as somas e tente novamente!</div>`;
    }
}

document.getElementById('start').addEventListener('input', gerarDesafio);

window.onload = gerarDesafio;
</script>
</body>
</html>
